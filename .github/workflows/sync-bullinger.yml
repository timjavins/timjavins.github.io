name: Sync Bullinger into pages
on:
  workflow_dispatch:
  repository_dispatch:
    types: [sync-bullinger]

permissions:
  contents: write

env:
  PAGES_SUBDIR: projects/Bullinger
  BUILD_COMMAND: "" # Set to custom build command if needed, e.g. "npm run build"
  
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pages repo (this repo)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Checkout Bullinger repository
        uses: actions/checkout@v4
        with:
          repository: timjavins/Bullinger
          path: bullinger
          ref: main
          # If Bullinger is private, create a personal access token (repo scope) and save it as REPO_TOKEN in this repo's secrets,
          # then uncomment the following line to use it:
          # token: ${{ secrets.REPO_TOKEN }}

      - name: Setup Node (for builds using npm)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build (if package.json exists) and copy into pages
        run: |
          set -e
          # Ensure target dir exists and is clean
          rm -rf ${{ env.PAGES_SUBDIR }} || true
          mkdir -p ${{ env.PAGES_SUBDIR }}

          # Work inside checked-out Bullinger repo
          cd bullinger

          if [ -f package.json ]; then
            echo "Detected package.json — running build (if available)"
            npm ci --silent || true

            if [ -n "${{ env.BUILD_COMMAND }}" ]; then
              echo "Running custom build command: ${{ env.BUILD_COMMAND }}"
              eval "${{ env.BUILD_COMMAND }}"
            else
              # try common build command; ignore failure (fallback to copying source)
              npm run build --silent || true
            fi

            # Prefer common build output folders; fall back to copying source
            if [ -d dist ]; then
              rsync -a --delete dist/ ../${{ env.PAGES_SUBDIR }}/
            elif [ -d build ]; then
              rsync -a --delete build/ ../${{ env.PAGES_SUBDIR }}/
            elif [ -d _site ]; then
              rsync -a --delete _site/ ../${{ env.PAGES_SUBDIR }}/
            else
              echo "No recognized build output found; copying source files instead"
              rsync -a --delete ./ ../${{ env.PAGES_SUBDIR }}/
            fi
          else
            echo "No package.json — copying repository source"
            rsync -a --delete ./ ../${{ env.PAGES_SUBDIR }}/
          fi

          # Remove any accidentally-copied Git metadata
          rm -rf ../${{ env.PAGES_SUBDIR }}/.git || true

      - name: Commit and push changes if any
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.PAGES_SUBDIR }} || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync Bullinger repository into ${PAGES_SUBDIR}"
            git push origin HEAD:main
          fi

# Notes
# - This workflow runs manually (workflow_dispatch) or when a repository_dispatch with type `sync-bullinger` is sent.
# - If Bullinger is ever private, add a personal access token (repo scope) to this repo's secrets as REPO_TOKEN and uncomment the token line above.
# - To customize build behavior, set the BUILD_COMMAND environment variable to something like "npm run build --if-present" in the workflow file or as a repository secret.
# - Because triggers are manual or repository_dispatch, the commit pushed by the workflow will not automatically retrigger the workflow (avoids infinite loops).
