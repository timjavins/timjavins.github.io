name: Sync Bullinger into pages (create PR)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [sync-bullinger]

permissions:
  contents: write
  pull-requests: write

env:
  PAGES_SUBDIR: projects/Bullinger
  BUILD_COMMAND: "" # Set to a build command if Bullinger needs one, e.g. "npm run build"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pages repo (use default branch)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          clean: true
          fetch-depth: 1
          # intentionally not setting `ref:` so the repository default branch is used

      - name: Diagnose repo after checkout
        run: |
          echo "Working dir: $(pwd)"
          echo "Git status:"
          git status --porcelain --untracked-files=no || true
          echo "Local branches:"
          git branch --show-current || true
          echo "Remote refs (ls-remote):"
          git ls-remote origin || true

      - name: Checkout Bullinger repository (use its default branch)
        uses: actions/checkout@v4
        with:
          repository: timjavins/Bullinger
          path: bullinger
          persist-credentials: false
          clean: true
          fetch-depth: 1
          # If Bullinger is private, create a PAT with repo scope and add it as REPO_TOKEN, then set:
          # token: ${{ secrets.REPO_TOKEN }}

      - name: Show Bullinger repo info (diagnose)
        run: |
          echo "Bullinger path: $(pwd)/bullinger"
          ls -la bullinger | sed -n '1,200p' || true
          if [ -d bullinger ]; then
            (cd bullinger && git rev-parse --abbrev-ref HEAD || true)
          fi

      - name: Setup Node (for builds using npm)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build (if package.json exists) and copy into pages
        id: sync_files
        run: |
          set -e
          rm -rf ${{ env.PAGES_SUBDIR }} || true
          mkdir -p ${{ env.PAGES_SUBDIR }}

          cd bullinger

          if [ -f package.json ]; then
            echo "Detected package.json — attempting build"
            npm ci --silent || true

            if [ -n "${{ env.BUILD_COMMAND }}" ]; then
              echo "Running custom build command: ${{ env.BUILD_COMMAND }}"
              eval "${{ env.BUILD_COMMAND }}"
            else
              npm run build --silent || true
            fi

            if [ -d dist ]; then
              rsync -a --delete dist/ ../${{ env.PAGES_SUBDIR }}/
            elif [ -d build ]; then
              rsync -a --delete build/ ../${{ env.PAGES_SUBDIR }}/
            elif [ -d _site ]; then
              rsync -a --delete _site/ ../${{ env.PAGES_SUBDIR }}/
            else
              echo "No recognized build output; copying source"
              rsync -a --delete ./ ../${{ env.PAGES_SUBDIR }}/
            fi
          else
            echo "No package.json — copying source"
            rsync -a --delete ./ ../${{ env.PAGES_SUBDIR }}/
          fi

          rm -rf ../${{ env.PAGES_SUBDIR }}/.git || true

          cd ..
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create pull request if changes detected
        if: steps.sync_files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Sync Bullinger repository into ${PAGES_SUBDIR}"
          branch: sync/bullinger-${{ github.run_id }}
          title: "Sync Bullinger into pages"
          body: |
            Automated sync of timjavins/Bullinger into ${PAGES_SUBDIR}.
            This PR was created by the site sync workflow.
          labels: automated-sync

      - name: No changes message
        if: steps.sync_files.outputs.changed == 'false'
        run: echo "No changes found; nothing to commit or PR."
